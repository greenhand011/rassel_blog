---
title: 'å¦‚ä½•è¯†åˆ« WebShell æˆ– SQL æ³¨å…¥ï¼Ÿä»ä¿¡æ¯ç†µåˆ°å¤šç‰¹å¾èåˆçš„å®æˆ˜å®éªŒ'
date: '2025-XX-XX'
tags: ['Webå®‰å…¨', 'AIå®‰å…¨']
description: 'ä»é›¶å®ç°åŸºäºä¿¡æ¯ç†µ + å­—ç¬¦ N-gram + è§„åˆ™èåˆçš„ WebShell æ£€æµ‹å®éªŒï¼Œå®Œæ•´ä»£ç ä¸å®éªŒåˆ†æã€‚'
---

## å‰è¨€

åœ¨çœŸå®çš„ Web å®‰å…¨å¯¹æŠ—ä¸­ï¼Œ**WebShell å¾€å¾€å¹¶ä¸æ˜¯"æ˜æ˜¾æ¶æ„"çš„ä»£ç **ã€‚  
å®ƒä»¬é€šå¸¸å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- é«˜åº¦æ··æ·†ï¼ˆBase64 / gzip / å­—ç¬¦æ‹¼æ¥ï¼‰
- å­—ç¬¦åˆ†å¸ƒå¼‚å¸¸
- è¯­ä¹‰ä¸ŠåŒ…å«å±é™©æ‰§è¡Œé€»è¾‘ï¼ˆ`eval` / `system` / `assert`ï¼‰
- ç»“æ„ä¸Š"çŸ­å°ã€ç›´æ¥ã€åŠŸèƒ½å•ä¸€"

æœ¬æ–‡ä¸ä¼šä¸€ä¸Šæ¥å°±ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œè€Œæ˜¯**ä»å®‰å…¨å·¥ç¨‹æœ€åŸºç¡€ã€æœ€å¯é çš„è§’åº¦å‡ºå‘**ï¼š

> ğŸ‘‰ ç”¨æ•°æ®éªŒè¯ï¼Œç”¨è§„åˆ™è§£é‡Šï¼Œç”¨èåˆé™ä½è¯¯æŠ¥ã€‚

æˆ‘ä»¬å°†å®Œæ•´èµ°å®Œä»¥ä¸‹è·¯å¾„ï¼š

1. ä¿¡æ¯ç†µæ£€æµ‹ï¼ˆæ··æ·†ç¨‹åº¦ï¼‰
2. é˜ˆå€¼å®éªŒï¼ˆRule-basedï¼‰
3. å­—ç¬¦ N-gram + TF-IDFï¼ˆè¯­ä¹‰ç‰¹å¾ï¼‰
4. å¤šç‰¹å¾èåˆï¼ˆå·¥ç¨‹çº§æ£€æµ‹é€»è¾‘ï¼‰

---

## 0. å®éªŒç¯å¢ƒå‡†å¤‡

### 0.1 Python ç¯å¢ƒ

ç¡®ä¿ä½ èƒ½è¿è¡Œï¼š

\```bash
python --version
\```

æ¨èç‰ˆæœ¬ï¼šPython â‰¥ 3.9

### 0.2 å®‰è£…æœ€å°ä¾èµ–

\```bash
pip install numpy pandas matplotlib scikit-learn
\```

---

## 1. å®éªŒæ•°æ®å‡†å¤‡

### 1.1 ç›®å½•ç»“æ„

\```text
entropy_webshell_exp/
â”œâ”€â”€ data/
â”‚ â”œâ”€â”€ benign.txt
â”‚ â””â”€â”€ webshell.txt
â””â”€â”€ entropy_test.py
\```

### 1.2 æ­£å¸¸ PHP æ ·æœ¬ï¼ˆbenign.txtï¼‰

æ¯ä¸€è¡Œæ˜¯ä¸€æ®µå¯è¯»ã€ä½æ··æ·†çš„ PHP ä»£ç ï¼š

\```php

<?php echo "Hello World"; ?>

<?php $a = 1 + 2; echo $a; ?>

<?php include 'config.php'; ?>

<?php if ($user == 'admin') { echo 'ok'; } ?>

\```

**ğŸ“Œ è§„åˆ™ï¼š**

- ä¸åšæ··æ·†
- ä¸åŒ…å«åŠ¨æ€æ‰§è¡Œå‡½æ•°
- ç¬¦åˆæ­£å¸¸ä¸šåŠ¡é€»è¾‘

### 1.3 WebShell æ ·æœ¬ï¼ˆwebshell.txtï¼‰

\```php

<?php eval(base64_decode("cGhwaW5mbygpOw==")); ?>

<?php @assert($_POST['x']); ?>

<?php $a="ZXZhbCgkX1BPU1RbJ3gnXSk7";eval(base64_decode($a)); ?>

<?php preg_replace("/.*/e", $_POST['cmd'], ""); ?>

\```

è¿™äº›æ ·æœ¬è¦†ç›–äº†å¸¸è§åé—¨å½¢å¼ï¼š

- Base64 + eval
- assert åé—¨
- å˜é‡æ‹¼æ¥æ‰§è¡Œ
- preg_replace /e ä»£ç æ‰§è¡Œ

---

## 2. æ‰‹å†™ Shannon ä¿¡æ¯ç†µå‡½æ•°

### 2.1 ä¸ºä»€ä¹ˆä¿¡æ¯ç†µï¼Ÿ

**ç›´è§‰è§£é‡Šï¼š**

- æ­£å¸¸ä»£ç ï¼šå­—ç¬¦åˆ†å¸ƒä¸å‡åŒ€
- æ··æ·†ä»£ç ï¼šå­—ç¬¦åˆ†å¸ƒè¶‹å‘å‡åŒ€

è¿™æ­£æ˜¯ Shannon Entropy èƒ½æ•æ‰çš„ä¿¡å·ã€‚

<img src="/static/images/detect_webshell/shannon.png" alt="é¦™å†œç†µå…¬å¼" width="700" />

### 2.2 ç†µå‡½æ•°å®ç°

\```python
import math

def shannon_entropy(s: str) -> float:
if not s:
return 0.0

    length = len(s)
    entropy = 0.0

    for c in set(s):
        p = s.count(c) / length
        entropy -= p * math.log2(p)

    return entropy

\```

### 2.3 å¿«é€Ÿ sanity check

\```python
test_strings = [
"aaaaaa",
"abcdef",
"hello world",
"cGhwaW5mbygpOw=="
]

for s in test_strings:
print(s, "->", shannon_entropy(s))
\```

<img src="/static/images/detect_webshell/diff_entropy.png" alt="å¿«é€Ÿä»£ç ç†µ" width="700" />

---

## 3. WebShell vs æ­£å¸¸ä»£ç çš„çœŸå®ç†µåˆ†å¸ƒ

### 3.1 è¯»å–æ•°æ®

\```python
def load_lines(path):
with open(path, encoding="utf-8") as f:
return [line.strip() for line in f if line.strip()]

benign_codes = load_lines("data/benign.txt")
webshell_codes = load_lines("data/webshell.txt")
\```

### 3.2 è®¡ç®—æ¯æ¡ä»£ç çš„ä¿¡æ¯ç†µ

\```python
benign_entropy = [shannon_entropy(c) for c in benign_codes]
webshell_entropy = [shannon_entropy(c) for c in webshell_codes]

print("æ­£å¸¸ä»£ç ç†µ:", benign_entropy)
print("WebShell ç†µ:", webshell_entropy)
\```

<img src="/static/images/detect_webshell/diff_benign_shell.png" alt="é¦™å†œç†µå¯¹æ¯”" width="700" />
å·²ç»å®é™…è·‘å‡ºäº†ï¼š

\```text
Benign Mean Entropy: 3.97
WebShell Mean Entropy: 4.81
\```

**ğŸ“Œ ç»“è®º 1ï¼ˆé‡è¦ï¼‰ï¼š**

WebShell çš„å¹³å‡ä¿¡æ¯ç†µæ˜¾è‘—é«˜äºæ­£å¸¸ä»£ç ï¼Œä¸”åˆ†å¸ƒæ›´é›†ä¸­ã€‚

---

## 4. ä¿¡æ¯ç†µåˆ†å¸ƒå¯è§†åŒ–

\```python
import matplotlib.pyplot as plt

plt.hist(benign_entropy, bins=10, alpha=0.7, label="Benign")
plt.hist(webshell_entropy, bins=10, alpha=0.7, label="WebShell")
plt.legend()
plt.xlabel("Entropy")
plt.ylabel("Count")
plt.title("Entropy Distribution")
plt.grid(True)
plt.show()
\```

<img src="/static/images/detect_webshell/histogram.png" alt="ç›´æ–¹å›¾" width="700" />

---

## 5. åŸºäºä¿¡æ¯ç†µçš„é˜ˆå€¼æ£€æµ‹å®éªŒ

### 5.1 æ£€æµ‹å‡½æ•°

\```python
def entropy_detect(code, threshold):
return shannon_entropy(code) >= threshold
\```

### 5.2 é˜ˆå€¼è¯„ä¼°

\```python
def evaluate_threshold(threshold, benign_codes, webshell_codes):
benign_fp = 0
webshell_tp = 0

    for c in benign_codes:
        if entropy_detect(c, threshold):
            benign_fp += 1

    for c in webshell_codes:
        if entropy_detect(c, threshold):
            webshell_tp += 1

    return benign_fp, webshell_tp

thresholds = [4.0, 4.5, 4.8]

for t in thresholds:
fp, tp = evaluate_threshold(t, benign_codes, webshell_codes)
print(t, fp, tp)
\```

ä½ è·‘å‡ºçš„çœŸå®ç»“æœæ˜¯ï¼š

\```text
Threshold=4.5
æ­£å¸¸ä»£ç è¯¯æŠ¥: 0/4
WebShell å‘½ä¸­: 4/4
\```

<img src="/static/images/detect_webshell/threshold.png" alt="å®éªŒç»“æœ" width="700" />
**ğŸ“Œ ç»“è®º 2ï¼š**

ä¿¡æ¯ç†µæ˜¯ä¸€ä¸ª"å¼ºä¿¡å·"ï¼Œä½†å®ƒæ— æ³•è§£é‡Š"ä¸ºä»€ä¹ˆ"ã€‚

---

## 6. å­—ç¬¦ N-gram + TF-IDFï¼ˆè¯­ä¹‰ç‰¹å¾ï¼‰

### 6.1 ä¸ºä»€ä¹ˆä¸ç”¨è¯çº§ï¼Ÿ

WebShell æ ·æœ¬ä¸­å¤§é‡å­˜åœ¨ï¼š

\```php
eval(base64_decode("..."))
\```

ğŸ‘‰ å­—ç¬¦çº§ N-gram æ‰èƒ½æ•æ‰è¿™ç§æ¨¡å¼

### 6.2 æ„é€  TF-IDF

\```python
from sklearn.feature_extraction.text import TfidfVectorizer
import numpy as np

vectorizer = TfidfVectorizer(
analyzer="char",
ngram_range=(3, 6)
)

X = benign_codes + webshell_codes
X_tfidf = vectorizer.fit_transform(X)
\```

### 6.3 é«˜é£é™© N-gram åˆ†æ

\```python
feature_names = vectorizer.get_feature_names_out()

# åˆ†å‰²æ­£å¸¸å’ŒWebShellçš„ç‰¹å¾çŸ©é˜µ

X_benign = X_tfidf[:len(benign_codes)]
X_webshell = X_tfidf[len(benign_codes):]

# è®¡ç®—å¹³å‡ç‰¹å¾å‘é‡

benign_mean = np.mean(X_benign.toarray(), axis=0)
webshell_mean = np.mean(X_webshell.toarray(), axis=0)

# è®¡ç®—å·®å¼‚

diff = webshell_mean - benign_mean

# æ‰¾å‡ºå·®å¼‚æœ€å¤§çš„ç‰¹å¾

top_idx = np.argsort(diff)[-20:]

print("\næœ€åå‘ WebShell çš„ N-gramï¼š")
for i in reversed(top_idx):
print(feature_names[i], "â†’", round(diff[i], 4))
\```

ä½ è§‚å¯Ÿåˆ°çš„é«˜é£é™©ç‰¹å¾åŒ…æ‹¬ï¼š

\```text
$\_post eval system ); ?>
\```

<img src="/static/images/detect_webshell/ngram.png" alt="ç›´æ–¹å›¾" width="700" />
**ğŸ“Œ ç»“è®º 3ï¼š**

TF-IDF æ•æ‰çš„æ˜¯"æ”»å‡»è¯­ä¹‰"ï¼Œè€Œä¸æ˜¯æ··æ·†ç¨‹åº¦ã€‚

---

## 7. å¤šç‰¹å¾èåˆï¼ˆå·¥ç¨‹çº§æ£€æµ‹ï¼‰

### 7.1 ä¸‰ç±»è¯æ®å›é¡¾

| ç‰¹å¾     | ä½œç”¨             |
| -------- | ---------------- |
| ä¿¡æ¯ç†µ   | åˆ¤æ–­æ˜¯å¦æ··æ·†     |
| TF-IDF   | åˆ¤æ–­æ˜¯å¦æ”»å‡»è¯­ä¹‰ |
| ç»“æ„ç‰¹å¾ | åˆ¤æ–­æ˜¯å¦å¼‚å¸¸æ‰§è¡Œ |

### 7.2 èåˆåˆ¤å®šå‡½æ•°

\```python
def tfidf_detect(code): # ä½¿ç”¨è®­ç»ƒå¥½çš„ vectorizer å’Œåˆ†ç±»å™¨ # è¿™é‡Œç®€åŒ–ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨
features = vectorizer.transform([code]) # è¿™é‡Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ†ç±»å™¨ clf # return clf.predict(features)[0] == 1 # ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„è§„åˆ™ï¼šå¦‚æœåŒ…å«é«˜å±ç‰¹å¾
high_risk_ngrams = ['eval', 'system', 'assert', '$_POST', '$_GET']
for ngram in high_risk_ngrams:
if ngram in code:
return True
return False

def fusion_detect(code,
entropy_threshold=4.5,
w_entropy=0.4,
w_tfidf=0.4,
w_structure=0.2,
decision_threshold=0.5):

    entropy_hit = entropy_detect(code, entropy_threshold)
    tfidf_hit = tfidf_detect(code)
    structure_hit = '); ?>' in code

    score = (
        w_entropy * int(entropy_hit) +
        w_tfidf * int(tfidf_hit) +
        w_structure * int(structure_hit)
    )

    return score >= decision_threshold

\```

**ğŸ“Œ ä¸ºä»€ä¹ˆè¿™æ ·é…æƒé‡ï¼Ÿ**

- ç†µï¼šå¼ºä½†æ³›åŒ–
- TF-IDFï¼šç²¾å‡†ä½†ä¾èµ–è§„åˆ™
- ç»“æ„ï¼šè¾…åŠ©ä¿¡å·

<img src="/static/images/detect_webshell/result1.png" alt="åˆæ­¥åˆ¤æ–­ç»“æœ" width="700" />
å¯ä»¥å‘ç°ç»“æœå¹¶ä¸æ˜¯ç‰¹åˆ«ç²¾å‡†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒæ•´è§„åˆ™ ### 7.3 èåˆåˆ¤å®šå‡½æ•° é‡æ–°å®šä¹‰â€œå¼º / å¼±ç‰¹å¾â€
å¼ºæ”»å‡»ç‰¹å¾ï¼ˆå•ç‹¬å³å¯åˆ¤ï¼‰ \```python STRONG_EXEC = [ Â  Â  'eval', 'system', 'assert', Â  Â 
'shell_exec', 'passthru', Â  Â  'base64_decode', 'gzinflate' ] å¼±å¯ç–‘ç‰¹å¾ï¼ˆå¿…é¡»ç»„åˆï¼‰

WEAK_INPUT = [
Â  Â  '$_post', '$_get', '$_request'
]

WEAK_STRUCT = [
Â  Â  '); ?>'
]
\```python
def semantic_detect(code):
Â  Â  code = code.lower()

Â  Â  # å¼ºç‰¹å¾ï¼šç›´æ¥è¿”å› True
Â  Â  for kw in STRONG_EXEC:
Â  Â  Â  Â  if kw in code:
Â  Â  Â  Â  Â  Â  return "strong"

Â  Â  weak_hits = 0
Â  Â  for kw in WEAK_INPUT:
Â  Â  Â  Â  if kw in code:
Â  Â  Â  Â  Â  Â  weak_hits += 1
Â  Â  for kw in WEAK_STRUCT:
Â  Â  Â  Â  if kw in code:
Â  Â  Â  Â  Â  Â  weak_hits += 1

Â  Â  return "weak" if weak_hits >= 2 else "none"
\```
é‡å†™èåˆåˆ¤å®šé€»è¾‘
\```python
def fusion_detect_v2(code,
entropy_threshold=4.5):

    entropy_hit = entropy_detect(code, entropy_threshold)
    semantic_level = semantic_detect(code)

    # è§„åˆ™ 1ï¼šå¼ºè¯­ä¹‰å‘½ä¸­
    if semantic_level == "strong":
        return True, "Strong semantic hit"

    # è§„åˆ™ 2ï¼šç†µ + å¼±è¯­ä¹‰ç»„åˆ
    if entropy_hit and semantic_level == "weak":
        return True, "Entropy + weak semantic"

    return False, "Benign"

\```

<img src="/static/images/detect_webshell/result.png" alt="æœ€ç»ˆç»“æœ" width="700" />
---

## æ€»ç»“

è¿™ä¸æ˜¯ä¸€ä¸ª"æ¨¡å‹ Demo"ï¼Œè€Œæ˜¯ä¸€ä¸ªå®‰å…¨å·¥ç¨‹çœŸå®å¯è½åœ°çš„æ£€æµ‹æ€è·¯ï¼š

- ç”¨ç†µå‘ç°å¼‚å¸¸
- ç”¨è¯­ä¹‰è§£é‡Šå¼‚å¸¸
- ç”¨èåˆé™ä½è¯¯æŠ¥

çœŸæ­£çš„å®‰å…¨æ£€æµ‹ï¼Œä»æ¥ä¸æ˜¯å•ä¸€ç‰¹å¾ã€‚
