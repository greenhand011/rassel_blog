---
title: 'å¦‚ä½•è¯†åˆ« WebShell æˆ– SQL æ³¨å…¥ï¼Ÿä»ä¿¡æ¯ç†µåˆ°å¤šç‰¹å¾èåˆçš„å®æˆ˜å®éªŒ'
date: '2025-12-21'
tags: ['AI Security']
draft: false
summary: 'æ‘’å¼ƒé»‘ç›’æ¨¡å‹ï¼Œä»é›¶å®ç°åŸºäºä¿¡æ¯ç†µ + å­—ç¬¦ N-gram + è§„åˆ™èåˆçš„ WebShell æ£€æµ‹å®éªŒï¼ŒåŒ…å«å®Œæ•´å·¥ç¨‹ä»£ç ä¸æ•°æ®åˆ†æã€‚'
---

## å‰è¨€

åœ¨çœŸå®çš„ Web å®‰å…¨å¯¹æŠ—ä¸­ï¼Œ**WebShell å¾€å¾€ä¼ªè£…å¾—æå¥½**ã€‚å®ƒä»¬é€šå¸¸å…·å¤‡ä»¥ä¸‹â€œåç›´è§‰â€ç‰¹ç‚¹ï¼š

> âš ï¸ **WebShell çš„éšè”½ç‰¹å¾ï¼š**
>
> - **é«˜åº¦æ··æ·†**ï¼šåˆ©ç”¨ Base64ã€Gzipã€æ—‹è½¬å­—ç¬¦ç­‰æ–¹å¼é€ƒé¿é™æ€ç‰¹å¾åŒ¹é…ã€‚
> - **ç»Ÿè®¡å¼‚å¸¸**ï¼šä¸ºäº†å‹ç¼©ä»£ç ä½“ç§¯ï¼Œå­—ç¬¦åˆ†å¸ƒå¾€å¾€è¿èƒŒè‡ªç„¶è¯­è¨€è§„å¾‹ã€‚
> - **é«˜å±è¯­ä¹‰**ï¼šå¿…ç„¶åŒ…å« `eval`ã€`system`ã€`assert` ç­‰æ‰§è¡Œé€»è¾‘ã€‚
> - **æç®€ç»“æ„**ï¼šçŸ­å°ã€ç›´æ¥ã€åŠŸèƒ½å•ä¸€ã€‚

æœ¬æ–‡ä¸ä½¿ç”¨ä¸å¯è§£é‡Šçš„é»‘ç›’æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œè€Œæ˜¯**ä»å®‰å…¨å·¥ç¨‹æœ€åŸºç¡€ã€æœ€å¯è§£é‡Šçš„è§’åº¦å‡ºå‘**ï¼š

**ğŸ‘‰ æ ¸å¿ƒè·¯å¾„ï¼šç”¨æ•°æ®éªŒè¯ -> ç”¨è§„åˆ™è§£é‡Š -> ç”¨èåˆé™ä½è¯¯æŠ¥ã€‚**

æˆ‘ä»¬å°†å®Œæ•´å¤ç°ä»¥ä¸‹æ£€æµ‹é€»è¾‘ï¼š

1.  **ä¿¡æ¯ç†µæ£€æµ‹**ï¼ˆé‡åŒ–æ··æ·†ç¨‹åº¦ï¼‰
2.  **é˜ˆå€¼å®éªŒ**ï¼ˆç¡®å®š Rule-based è¾¹ç•Œï¼‰
3.  **TF-IDF + N-gram**ï¼ˆæå–æ”»å‡»è¯­ä¹‰ï¼‰
4.  **å¤šç‰¹å¾èåˆ**ï¼ˆæ„å»ºå·¥ç¨‹çº§æ£€æµ‹å™¨ï¼‰

---

## 0. å®éªŒç¯å¢ƒå‡†å¤‡

### 0.1 Python ç¯å¢ƒ

ç¡®ä¿ç¯å¢ƒæ»¡è¶³åŸºç¡€è¦æ±‚ï¼š

```bash
python --version
# æ¨èç‰ˆæœ¬ï¼šPython â‰¥ 3.9
```

### 0.2 å®‰è£…ä¾èµ–

æˆ‘ä»¬éœ€è¦ `scikit-learn` è¿›è¡Œå‘é‡åŒ–å¤„ç†ï¼Œ`numpy` è¿›è¡Œæ•°å€¼è®¡ç®—ï¼š

```bash
pip install numpy pandas matplotlib scikit-learn
```

---

## 1. å®éªŒæ•°æ®å‡†å¤‡

### 1.1 ç›®å½•ç»“æ„è®¾è®¡

```text
entropy_webshell_exp/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ benign.txt    # æ­£å¸¸ä¸šåŠ¡ä»£ç æ ·æœ¬
â”‚   â””â”€â”€ webshell.txt  # æ¶æ„è„šæœ¬æ ·æœ¬
â””â”€â”€ entropy_test.py   # å®éªŒä¸»è„šæœ¬
```

### 1.2 æ­£å¸¸ PHP æ ·æœ¬ (`benign.txt`)

é€‰å–å¯è¯»æ€§å¼ºã€ç¬¦åˆä¸šåŠ¡é€»è¾‘çš„ä»£ç ï¼š

```php
<?php echo "Hello World"; ?>

<?php $a = 1 + 2; echo $a; ?>

<?php include 'config.php'; ?>

<?php if ($user == 'admin') { echo 'ok'; } ?>
```

### 1.3 WebShell æ ·æœ¬ (`webshell.txt`)

é€‰å–åŒ…å«å…¸å‹æ··æ·†å’Œæ‰§è¡Œé€»è¾‘çš„æ ·æœ¬ï¼ˆ**æ³¨æ„ï¼šä»£ç å—å·²åšé˜²æŠ¥é”™å¤„ç†**ï¼‰ï¼š

```php
<?php eval(base64_decode("cGhwaW5mbygpOw==")); ?>

<?php @assert($_POST['x']); ?>

<?php $a="ZXZhbCgkX1BPU1RbJ3gnXSk7";eval(base64_decode($a)); ?>

<?php preg_replace("/.*/e", $_POST['cmd'], ""); ?>
```

> ğŸ’¡ **æ ·æœ¬åˆ†æ**ï¼šè¿™äº›ä»£ç è¦†ç›–äº† Base64 ç¼–ç ã€æ–­è¨€æ‰§è¡Œã€å˜é‡æ‹¼æ¥å’Œæ­£åˆ™æ›¿æ¢æ‰§è¡Œç­‰ç»å…¸æ”»å‡»æ‰‹æ³•ã€‚

---

## 2. æ ¸å¿ƒç®—æ³•ï¼šShannon ä¿¡æ¯ç†µ

### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©ä¿¡æ¯ç†µï¼Ÿ

**ç›´è§‰è§£é‡Šï¼š**

- **æ­£å¸¸ä»£ç **ï¼šå…³é”®è¯é‡å¤å‡ºç°ï¼ˆå¦‚ `function`, `return`ï¼‰ï¼Œå­—ç¬¦åˆ†å¸ƒä¸å‡åŒ€ï¼Œ**ç†µè¾ƒä½**ã€‚
- **æ··æ·†ä»£ç **ï¼šä¸ºäº†éšè—ç‰¹å¾ï¼Œå¾€å¾€é€šè¿‡ Base64 æˆ–åŠ å¯†æ‰“ä¹±å­—ç¬¦é¡ºåºï¼Œå­—ç¬¦åˆ†å¸ƒè¶‹å‘éšæœºï¼Œ**ç†µæé«˜**ã€‚

å…¬å¼å¦‚ä¸‹ï¼š

<img src="/static/images/detect_webshell/shannon.png" alt="é¦™å†œç†µå…¬å¼" width="600" />

### 2.2 Python å®ç°

æˆ‘ä»¬å®ç°ä¸€ä¸ªå·¥ä¸šçº§é²æ£’çš„ç†µè®¡ç®—å‡½æ•°ï¼š

```python
import math
from collections import Counter

def shannon_entropy(s: str) -> float:
    """
    è®¡ç®—å­—ç¬¦ä¸²çš„é¦™å†œä¿¡æ¯ç†µ (Shannon Entropy)
    """
    if not s:
        return 0.0

    length = len(s)
    counts = Counter(s)
    entropy = 0.0

    for count in counts.values():
        p = count / length
        entropy -= p * math.log2(p)

    return entropy
```

### 2.3 å¿«é€Ÿ Sanity Check

```python
test_cases = [
    ("aaaaaa", "æä½ç†µï¼ˆå•ä¸€å­—ç¬¦ï¼‰"),
    ("hello world", "ä½ç†µï¼ˆè‡ªç„¶è¯­è¨€ï¼‰"),
    ("cGhwaW5mbygpOw==", "é«˜ç†µï¼ˆBase64æ··æ·†ï¼‰")
]

for s, desc in test_cases:
    print(f"String: {s[:15]:<15} | Entropy: {shannon_entropy(s):.4f} ({desc})")
```

<img src="/static/images/detect_webshell/diff_entropy.png" alt="å¿«é€Ÿä»£ç ç†µéªŒè¯" width="700" />

---

## 3. å®éªŒï¼šWebShell vs æ­£å¸¸ä»£ç çš„ç†µåˆ†å¸ƒ

### 3.1 æ•°æ®åŠ è½½

```python
def load_lines(path: str) -> list[str]:
    try:
        with open(path, encoding="utf-8", errors='ignore') as f:
            return [line.strip() for line in f if line.strip()]
    except FileNotFoundError:
        print(f"Error: {path} not found.")
        return []

benign_codes = load_lines("data/benign.txt")
webshell_codes = load_lines("data/webshell.txt")
```

### 3.2 è®¡ç®—ä¸å¯¹æ¯”

```python
import numpy as np

benign_entropy = [shannon_entropy(c) for c in benign_codes]
webshell_entropy = [shannon_entropy(c) for c in webshell_codes]

print(f"æ­£å¸¸ä»£ç å¹³å‡ç†µ: {np.mean(benign_entropy):.2f}")
print(f"WebShellå¹³å‡ç†µ: {np.mean(webshell_entropy):.2f}")
```

<img src="/static/images/detect_webshell/diff_benign_shell.png" alt="é¦™å†œç†µå¯¹æ¯”" width="700" />

**å®éªŒæ•°æ®è¡¨æ˜ï¼š**

> **Benign Mean Entropy: 3.97**
> **WebShell Mean Entropy: 4.81**
>
> ç»“è®ºï¼šWebShell çš„ç†µå€¼æ˜¾è‘—é«˜äºæ­£å¸¸ä»£ç ï¼Œä¸”åˆ†å¸ƒåŒºé—´æ›´åŠ é›†ä¸­ã€‚

---

## 4. å¯è§†åŒ–ï¼šæ•°æ®ä¼šè¯´è¯

é€šè¿‡ç›´æ–¹å›¾å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ä¸¤ç±»æ ·æœ¬åœ¨â€œç†µç©ºé—´â€ä¸Šçš„å¯åˆ†æ€§ï¼š

```python
import matplotlib.pyplot as plt

plt.figure(figsize=(10, 6))
plt.hist(benign_entropy, bins=10, alpha=0.7, label="Benign (Normal)", color='green')
plt.hist(webshell_entropy, bins=10, alpha=0.7, label="WebShell (Malicious)", color='red')
plt.axvline(x=4.5, color='black', linestyle='--', label='Threshold (4.5)')

plt.legend()
plt.xlabel("Shannon Entropy Score")
plt.ylabel("Sample Count")
plt.title("Entropy Distribution Analysis")
plt.grid(True, alpha=0.3)
plt.show()
```

<img src="/static/images/detect_webshell/histogram.png" alt="ç†µåˆ†å¸ƒç›´æ–¹å›¾" width="700" />

---

## 5. å±€é™æ€§åˆ†æ

è™½ç„¶ç†µæ˜¯ä¸€ä¸ªå¼ºç‰¹å¾ï¼Œä½†å®ƒå­˜åœ¨è‡´å‘½ç¼ºé™·ï¼š**æ— æ³•è§£é‡Šâ€œä¸ºä»€ä¹ˆâ€**ã€‚

```python
# è¯¯æŠ¥æ¡ˆä¾‹ï¼š
normal_code = '$image_data = "iVBORw0KGgoAAAANSUhEUgAAAAE...";' # æ­£å¸¸çš„å›¾ç‰‡Base64
print(shannon_entropy(normal_code)) # ç»“æœæé«˜ï¼Œä¼šè¢«è¯¯åˆ¤ä¸º WebShell
```

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥**è¯­ä¹‰ç‰¹å¾**ã€‚

---

## 6. è¿›é˜¶ç‰¹å¾ï¼šCharacter N-gram + TF-IDF

### 6.1 ä¸ºä»€ä¹ˆæ˜¯å­—ç¬¦çº§ N-gramï¼Ÿ

æ”»å‡»è€…å¸¸å°†ä»£ç æ‰“æ•£ï¼Œä¾‹å¦‚ `e"."v"."a"."l`ã€‚è¯è¢‹æ¨¡å‹ï¼ˆBag of Wordsï¼‰ä¼šå¤±æ•ˆï¼Œä½†**å­—ç¬¦çº§ N-gram** èƒ½æ•æ‰åˆ° `eva`, `val` ç­‰åºåˆ—ç‰¹å¾ã€‚

### 6.2 TF-IDF å‘é‡åŒ–

```python
from sklearn.feature_extraction.text import TfidfVectorizer

# æå– 3-gram åˆ° 6-gram çš„ç‰¹å¾
vectorizer = TfidfVectorizer(
    analyzer="char",
    ngram_range=(3, 6),
    max_features=1000
)

X_all = benign_codes + webshell_codes
X_tfidf = vectorizer.fit_transform(X_all)
```

### 6.3 æŒ–æ˜â€œé«˜å±â€ç‰¹å¾ç‰‡æ®µ

é€šè¿‡å¯¹æ¯”ä¸¤ç±»æ ·æœ¬çš„ TF-IDF å‡å€¼ï¼Œæˆ‘ä»¬æå–å‡ºäº†æœ€å…·åŒºåˆ†åº¦çš„ N-gramï¼š

```text
Highest Risk N-grams:
---------------------
1. $_po (User Input)
2. eval (Execution)
3. syst (System Command)
4. ); ? (Code Structure)
```

<img src="/static/images/detect_webshell/ngram.png" alt="N-gramç‰¹å¾åˆ†æ" width="700" />

---

## 7. ç»ˆææ–¹æ¡ˆï¼šå¤šç‰¹å¾å·¥ç¨‹èåˆ

å•ä¸€ç‰¹å¾ä¸å¯é ï¼Œæˆ‘ä»¬å°†**ç‰©ç†å±‚ï¼ˆç†µï¼‰**ã€**è¯­ä¹‰å±‚ï¼ˆTF-IDFï¼‰**å’Œ**ç»“æ„å±‚ï¼ˆè§„åˆ™ï¼‰**ç»“åˆã€‚

### 7.1 ç‰¹å¾å®šä¹‰

æˆ‘ä»¬å°†ç‰¹å¾åˆ†ä¸º **å¼ºæ”»å‡»ç‰¹å¾**ï¼ˆStrongï¼‰å’Œ **å¼±å¯ç–‘ç‰¹å¾**ï¼ˆWeakï¼‰ã€‚

```python
# å¼ºç‰¹å¾ï¼šä¸€æ—¦å‡ºç°ï¼ŒåŸºæœ¬ç¡®è®¤ä¸ºæ¶æ„ï¼ˆéœ€é…åˆç™½åå•ï¼‰
STRONG_EXEC_KEYWORDS = [
    'eval', 'system', 'assert', 'shell_exec',
    'passthru', 'base64_decode', 'gzinflate'
]

# å¼±ç‰¹å¾ï¼šå‡ºç°ä¸ä¸€å®šæ¶æ„ï¼Œä½†ç»„åˆå‡ºç°é£é™©æé«˜
WEAK_INPUT_KEYWORDS = ['$_POST', '$_GET', '$_REQUEST']
WEAK_STRUCT_KEYWORDS = ['); ?>', '<?php']
```

### 7.2 è¯­ä¹‰åˆ¤å®šé€»è¾‘

```python
def analyze_semantic_risk(code: str) -> str:
    """
    è¯­ä¹‰é£é™©ç­‰çº§è¯„ä¼°
    Returns: 'high', 'medium', 'low'
    """
    code_lower = code.lower()

    # Level 1: å¼ºç‰¹å¾åŒ¹é…
    for kw in STRONG_EXEC_KEYWORDS:
        if kw in code_lower:
            return "high"

    # Level 2: å¼±ç‰¹å¾ç»„åˆåŒ¹é…
    input_hits = sum(1 for kw in WEAK_INPUT_KEYWORDS if kw in code_lower)
    struct_hits = sum(1 for kw in WEAK_STRUCT_KEYWORDS if kw in code_lower)

    if input_hits >= 1 and struct_hits >= 1:
        return "medium"

    return "low"
```

### 7.3 èåˆåˆ¤å®šå¼•æ“ (Fusion Engine)

è¿™æ˜¯æœ¬å®éªŒçš„æ ¸å¿ƒäº§å‡ºâ€”â€”ä¸€ä¸ªåŸºäºè§„åˆ™èåˆçš„æ£€æµ‹å‡½æ•°ï¼š

```python
def fusion_detect(code: str, entropy_threshold: float = 4.5) -> tuple[bool, str]:
    """
    ç»¼åˆæ£€æµ‹å¼•æ“
    Returns: (is_webshell, reason)
    """
    # 1. è®¡ç®—ç‰©ç†ç‰¹å¾
    entropy = shannon_entropy(code)
    is_high_entropy = entropy >= entropy_threshold

    # 2. è®¡ç®—è¯­ä¹‰ç‰¹å¾
    risk_level = analyze_semantic_risk(code)

    # --- å†³ç­–é€»è¾‘ ---

    # æƒ…å†µ A: é«˜å±è¯­ä¹‰ + é«˜ç†µ (å…¸å‹æ··æ·†é©¬) -> æŠ¥é»‘
    if risk_level == "high" and is_high_entropy:
        return True, f"Critical: High Entropy ({entropy:.2f}) + Dangerous Keywords"

    # æƒ…å†µ B: ä»…é«˜å±è¯­ä¹‰ (ä¸€å¥è¯æœ¨é©¬ï¼Œæ— æ··æ·†) -> æŠ¥é»‘
    if risk_level == "high":
        return True, "Critical: Dangerous Execution Logic Found"

    # æƒ…å†µ C: ä¸­å±è¯­ä¹‰ + é«˜ç†µ (ç–‘ä¼¼æ··æ·†ä»£ç ) -> è­¦å‘Š
    if risk_level == "medium" and is_high_entropy:
        return True, f"Warning: Suspicious Structure + High Entropy ({entropy:.2f})"

    # æƒ…å†µ D: ä»…é«˜ç†µ (å¯èƒ½æ˜¯æ­£å¸¸çš„å›¾ç‰‡/å‹ç¼©æ•°æ®) -> å¿½ç•¥æˆ–ä½å±
    if is_high_entropy:
        return False, "Info: High Entropy but NO semantic risk (Likely data)"

    return False, "Clean"
```

<img src="/static/images/detect_webshell/result.png" alt="æœ€ç»ˆæ£€æµ‹ç»“æœ" width="700" />

---

## æ€»ç»“

è¿™ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ Demoï¼Œè€Œæ˜¯ä¸€ä¸ª**å¯è½åœ°çš„å®‰å…¨æ£€æµ‹æ€è·¯**ã€‚

1.  **ç†µ (Entropy)**ï¼šç”¨äºå¿«é€Ÿè¿‡æ»¤å’Œå‘ç°å¼‚å¸¸ï¼ˆå¦‚æ··æ·†ã€åŠ å¯†ï¼‰ã€‚
2.  **è¯­ä¹‰ (Semantics)**ï¼šç”¨äºç¡®è®¤æ”»å‡»æ„å›¾ï¼Œå‡å°‘â€œé«˜ç†µåˆæ³•æ•°æ®â€çš„è¯¯æŠ¥ã€‚
3.  **èåˆ (Fusion)**ï¼šé€šè¿‡ç®€å•çš„ `if-else` ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”æ— æ³•è§£é‡Šçš„â€œé»‘ç›’ AI æ¨¡å‹â€åœ¨å·¥ç¨‹ä¸Šæ›´å…·ä»·å€¼ã€‚

çœŸæ­£çš„å®‰å…¨é˜²å¾¡ï¼Œå¾€å¾€å»ºç«‹åœ¨å¯¹æ•°æ®çš„æ·±åˆ»ç†è§£ä¹‹ä¸Šï¼Œè€Œéç›²ç›®å †ç Œç®—æ³•ã€‚
