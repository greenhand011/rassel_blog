---
title: 'ä»ä¼ ç»Ÿ ML åˆ°æ·±åº¦å­¦ä¹ ï¼šä½¿ç”¨ LSTM å¤„ç†å®šé•¿æ¶æ„æµé‡åºåˆ—'
date: '2025-12-26'
tags: ['AI Security']
draft: false
summary: 'ç»§ CNN ä¹‹åï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æ¢ç´¢å¾ªç¯ç¥ç»ç½‘ç»œã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£ LSTM çš„â€œè®°å¿†â€åŸç†ï¼Œå¹¶æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨ PyTorch æ„å»ºä¸€ä¸ªèƒ½è¯»æ‡‚ä¸Šä¸‹æ–‡é€»è¾‘çš„æ¶æ„æµé‡/URL æ£€æµ‹æ¨¡å‹ã€‚'
---

## å‰è¨€ï¼šå½“â€œå…³é”®è¯â€ä¸å¤Ÿç”¨æ—¶

åœ¨ä¸Šä¸€ç¯‡å…³äº CNN çš„åšå®¢ä¸­ï¼Œæˆ‘ä»¬æŠŠ URL å½“ä½œä¸€å¼ **å›¾ç‰‡**æ¥çœ‹å¾…ï¼Œç”¨å·ç§¯æ ¸å»æ‰«æé‡Œé¢çš„â€œå…³é”®è¯â€ï¼ˆå¦‚ `login`, `admin`ï¼‰ã€‚è¿™ç§æ–¹æ³•å¯¹é’“é±¼ç½‘ç«™ï¼ˆPhishingï¼‰éå¸¸æœ‰æ•ˆã€‚

ä½†åœ¨é¢å¯¹æ›´å¤æ‚çš„ç½‘ç»œæ”»å‡»æ—¶ï¼Œä»…ä»…æ‰¾å…³é”®è¯å°±ä¸å¤Ÿç”¨äº†ã€‚æ¯”å¦‚ï¼š

- **DGAï¼ˆåŸŸåç”Ÿæˆç®—æ³•ï¼‰**ï¼š`xya-b12.ru`ï¼Œ`qwe-z88.cn`ã€‚è¿™äº›åŸŸåé‡Œæ²¡æœ‰æ•æ„Ÿè¯ï¼Œå¼‚å¸¸ä½“ç°åœ¨**å­—ç¬¦çš„æ’åˆ—é¡ºåº**ä¸ç¬¦åˆäººç±»è¯­è¨€ä¹ æƒ¯ã€‚
- **æ··æ·†çš„ Payload**ï¼šæ”»å‡»è€…æŠŠä»£ç æ‰“æ•£ã€å€’åºæˆ–æ’å…¥å¤§é‡æ— æ„ä¹‰å­—ç¬¦ã€‚

è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½**â€œæŒ‰é¡ºåºé˜…è¯»â€**å¹¶**â€œæ‹¥æœ‰è®°å¿†â€**çš„æ¨¡å‹ã€‚
è¿™å°±æ˜¯ **LSTM (Long Short-Term Memoryï¼Œé•¿çŸ­æœŸè®°å¿†ç½‘ç»œ)** çš„èˆå°ã€‚

---

## ä¸€ã€åŸç†æ‹†è§£ï¼šLSTM æ˜¯å¦‚ä½•â€œé˜…è¯»â€æµé‡çš„ï¼Ÿ

å¦‚æœè¯´ CNN æ˜¯â€œå¿«ç…§â€ï¼ŒLSTM å°±æ˜¯â€œå½•åƒâ€ã€‚

### 1.1 åºåˆ—ï¼ˆSequenceï¼‰çš„æ¦‚å¿µ

åœ¨ LSTM çœ¼é‡Œï¼Œä¸€æ¡ URL ä¸æ˜¯ä¸€å †æ•£ä¹±çš„å­—æ¯ï¼Œè€Œæ˜¯ä¸€ä¸ª**æ—¶é—´åºåˆ—**ï¼š
`w` -> `w` -> `w` -> `.` -> `b` ...

æ¯ä¸€ä¸ªå­—ç¬¦çš„å‡ºç°ï¼Œéƒ½åŸºäºå‰ä¸€ä¸ªå­—ç¬¦çš„é“ºå«ã€‚

- çœ‹åˆ° `http`ï¼ŒLSTM ä¼šæœŸå¾…åé¢å‡ºç° `://`ã€‚
- çœ‹åˆ° `.exe`ï¼ŒLSTM ä¼šç»“åˆå‰é¢çš„è®°å¿†ï¼ˆå¦‚æœæ˜¯ä¸‹è½½é“¾æ¥ï¼‰ï¼Œåˆ¤å®šä¸ºé«˜å±ã€‚

### 1.2 æ ¸å¿ƒæœºåˆ¶ï¼šé—å¿˜ä¸è®°å¿†

æ™®é€šç¥ç»ç½‘ç»œï¼ˆRNNï¼‰åƒé‡‘é±¼ï¼Œåªæœ‰ 7 ç§’è®°å¿†ï¼Œè¯»äº†åé¢å¿˜å‰é¢ã€‚
LSTM å‰å®³åœ¨å®ƒæœ‰ä¸‰ä¸ª**é—¨ï¼ˆGateï¼‰**ï¼Œä¸“é—¨ç®¡ç†è®°å¿†ï¼š

1.  **é—å¿˜é—¨ (Forget Gate)**ï¼šè¿™å¥è¯è¯»å®Œäº†ï¼Œå‰é¢çš„åºŸè¯ï¼ˆæ¯”å¦‚æ— æ„ä¹‰çš„å¡«å…… 0ï¼‰å¯ä»¥å¿˜äº†ã€‚
2.  **è¾“å…¥é—¨ (Input Gate)**ï¼šè¯»åˆ°äº† `.php?id=1`ï¼Œè¿™æ˜¯é‡è¦å‚æ•°ï¼Œèµ¶ç´§è®°å…¥â€œé•¿æ—¶è®°å¿†â€ã€‚
3.  **è¾“å‡ºé—¨ (Output Gate)**ï¼šæ ¹æ®å½“å‰çš„è®°å¿†ï¼Œåˆ¤æ–­ç°åœ¨çš„å®‰å…¨çŠ¶æ€ã€‚

> **ğŸŒŸ ç›´è§‚ç†è§£**ï¼š
> LSTM ç»´æŠ¤äº†ä¸€ä¸ª**â€œé»‘æ¿â€ (Cell State)**ã€‚æ¯è¯»ä¸€ä¸ªå­—ç¬¦ï¼Œå®ƒå°±æ ¹æ®å½“å‰å­—ç¬¦çš„é‡è¦æ€§ï¼Œå†³å®šæ˜¯æ“¦æ‰é»‘æ¿ä¸Šçš„ä¸€äº›å­—ï¼Œè¿˜æ˜¯å¾€é»‘æ¿ä¸Šæ–°å†™ä¸€äº›å­—ã€‚è¯»å®Œæœ€åä¸€ä¸ªå­—ç¬¦ï¼Œé»‘æ¿ä¸Šçš„å†…å®¹å°±æ˜¯æ•´æ¡ URL çš„â€œè¯»åæ„Ÿâ€ã€‚

---

## äºŒã€æ•°æ®å‡†å¤‡ï¼šå®šé•¿åºåˆ—å¤„ç†

LSTM è™½ç„¶èƒ½å¤„ç†å˜é•¿æ•°æ®ï¼Œä½†åœ¨å·¥ç¨‹å®ç°ä¸Šï¼ˆä¸ºäº†å¹¶è¡Œè®¡ç®—ï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸è¦æŠŠæ•°æ®å¤„ç†æˆ**å®šé•¿åºåˆ— (Fixed-Length Sequence)**ã€‚

è¿™ä¸€æ­¥çš„ä»£ç ä¸ CNN ç¯‡å®Œå…¨é€šç”¨ï¼Œæˆ‘ä»¬å¿«é€Ÿå›é¡¾ä¸€ä¸‹ã€‚

### 2.1 å­—å…¸ä¸ç¼–ç 

```python
import string
import torch
import pandas as pd
from torch.utils.data import Dataset, DataLoader

# 1. å­—ç¬¦è¡¨ï¼šæŠŠæ‰€æœ‰å¯èƒ½çš„å­—ç¬¦æ˜ å°„ä¸ºæ•°å­—
ALL_CHARS = string.printable
char2idx = {c: i + 1 for i, c in enumerate(ALL_CHARS)}
char2idx["<PAD>"] = 0  # 0 ç”¨äºå¡«å……

# 2. è®¾å®šå›ºå®šé•¿åº¦ï¼ˆæ—¶é—´æ­¥ Time Stepsï¼‰
MAX_LEN = 200

def encode_url(url):
    seq = [char2idx.get(c, 0) for c in url]
    # æˆªæ–­æˆ–å¡«å……ï¼Œä¿è¯æ‰€æœ‰è¾“å…¥éƒ½æ˜¯ [200] é•¿åº¦
    if len(seq) < MAX_LEN:
        seq += [0] * (MAX_LEN - len(seq))
    else:
        seq = seq[:MAX_LEN]
    return seq
```

### 2.2 æ•°æ®é›†åŠ è½½å™¨

```python
label2idx = {"benign": 0, "phishing": 1, "defacement": 2, "malware": 3}

class TrafficDataset(Dataset):
    def __init__(self, csv_path):
        self.df = pd.read_csv(csv_path)

    def __len__(self):
        return len(self.df)

    def __getitem__(self, idx):
        text = str(self.df.iloc[idx]["url"])
        label = self.df.iloc[idx]["type"]

        # X: åºåˆ—æ•°æ® [200]
        x = torch.tensor(encode_url(text), dtype=torch.long)
        # Y: æ ‡ç­¾
        y = torch.tensor(label2idx[label], dtype=torch.long)

        return x, y
```

---

## ä¸‰ã€æ„å»º LSTM æ¨¡å‹ (PyTorch å®ç°)

è¿™æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚æˆ‘ä»¬è¦æ­å»ºä¸€ä¸ªåŒ…å« Embedding å±‚ã€LSTM å±‚å’Œå…¨è¿æ¥å±‚çš„ç½‘ç»œã€‚

### 3.1 ä»£ç å®ç°

```python
import torch.nn as nn

class LSTM_Traffic_Detector(nn.Module):
    def __init__(self, vocab_size, num_classes, hidden_size=128):
        super().__init__()

        # 1. Embedding å±‚
        # å°†ç¨€ç–çš„å­—ç¬¦ ID (å¦‚ 5) è½¬æ¢ä¸ºç¨ å¯†çš„å‘é‡ (å¦‚ [0.1, -0.9, ...])
        # input: [Batch, 200] -> output: [Batch, 200, 64]
        self.embedding = nn.Embedding(
            num_embeddings=vocab_size,
            embedding_dim=64,
            padding_idx=0
        )

        # 2. LSTM å±‚
        # input_size=64: æ¥æ”¶ Embedding çš„è¾“å‡ºç»´åº¦
        # hidden_size=128: è®°å¿†å•å…ƒçš„å¤§å°ï¼Œè¶Šå¤§è¶Šèƒ½è®°ä½å¤æ‚æ¨¡å¼
        # batch_first=True: è¾“å…¥æ ¼å¼ä¸º [batch, seq, feature]
        self.lstm = nn.LSTM(
            input_size=64,
            hidden_size=hidden_size,
            batch_first=True
        )

        # 3. å…¨è¿æ¥å±‚
        # å°† LSTM æœ€åçš„è®°å¿†æ˜ å°„åˆ° 4 ä¸ªåˆ†ç±»ä¸Š
        self.fc = nn.Linear(hidden_size, num_classes)

    def forward(self, x):
        # x å½¢çŠ¶: [Batch, 200]

        # Step 1: åµŒå…¥
        x = self.embedding(x)
        # x å½¢çŠ¶: [Batch, 200, 64]

        # Step 2: è¿‡ LSTM
        # out: æ¯ä¸ªæ—¶é—´æ­¥çš„è¾“å‡º (ä¸€èˆ¬ä¸ç›´æ¥ç”¨)
        # (h_n, c_n): æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„ éšçŠ¶æ€ å’Œ ç»†èƒçŠ¶æ€
        _, (h_n, c_n) = self.lstm(x)

        # Step 3: å–è®°å¿†
        # h_n çš„å½¢çŠ¶: [1, Batch, Hidden_Size] (å•å±‚å•å‘ LSTM)
        # æˆ‘ä»¬å–æœ€åé‚£ä¸€å±‚çš„è¾“å‡ºï¼Œä½œä¸ºæ•´å¥è¯çš„â€œè¯»åæ„Ÿâ€
        final_memory = h_n[-1]
        # final_memory å½¢çŠ¶: [Batch, 128]

        # Step 4: åˆ†ç±»
        logits = self.fc(final_memory)
        return logits
```

### 3.2 å…³é”®ç‚¹è§£æ

- **`batch_first=True`**: è¿™æ˜¯ä¸€ä¸ªæ–°æ‰‹å¸¸çŠ¯çš„é”™è¯¯ã€‚PyTorch LSTM é»˜è®¤è¾“å…¥æ ¼å¼æ˜¯ `(Seq_Len, Batch, Dim)`ï¼Œä½†æˆ‘ä»¬æ•°æ®å¤„ç†ä¹ æƒ¯æ˜¯ `(Batch, Seq_Len)`ã€‚åŠ ä¸Šè¿™ä¸ªå‚æ•°å¯ä»¥é¿å…ç»´åº¦æ··ä¹±ã€‚
- **ä¸ºä»€ä¹ˆå– `h_n[-1]`ï¼Ÿ**: LSTM å¤„ç†å®Œåºåˆ—é•¿åº¦ä¸º 200 çš„æ•°æ®åï¼Œæœ€åæ—¶åˆ»çš„ `h_n` åŒ…å«äº†è¯»å®Œæ‰€æœ‰ 200 ä¸ªå­—ç¬¦åçš„å®Œæ•´ä¿¡æ¯ã€‚è¿™æ‰æ˜¯æˆ‘ä»¬éœ€è¦ç”¨äºåˆ†ç±»çš„ç‰¹å¾ã€‚

---

## å››ã€è®­ç»ƒä¸å®æˆ˜

è®­ç»ƒé€»è¾‘ä¸ CNN åŸºæœ¬ä¸€è‡´ï¼Œä½†ç”±äº LSTM æ— æ³•åƒ CNN é‚£æ ·å¹¶è¡Œè®¡ç®—ï¼ˆå¿…é¡»ç­‰å‰ä¸€ä¸ªå­—è¯»å®Œæ‰èƒ½è¯»ä¸‹ä¸€ä¸ªï¼‰ï¼Œ**è®­ç»ƒé€Ÿåº¦ä¼šæ˜¾è‘—å˜æ…¢**ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚

```python
import time

# --- é…ç½® ---
DEVICE = torch.device("cuda" if torch.cuda.is_available() else "cpu")
BATCH_SIZE = 64
EPOCHS = 5
CSV_PATH = "E:/dataset/malicious_phish.csv" # æ›¿æ¢ä½ çš„è·¯å¾„

# --- åˆå§‹åŒ– ---
dataset = TrafficDataset(CSV_PATH)
loader = DataLoader(dataset, batch_size=BATCH_SIZE, shuffle=True)

# è¯è¡¨å¤§å° = å­—ç¬¦æ•° + 1 (Padding)
model = LSTM_Traffic_Detector(
    vocab_size=len(char2idx)+1,
    num_classes=4
).to(DEVICE)

optimizer = torch.optim.Adam(model.parameters(), lr=0.001)
criterion = nn.CrossEntropyLoss()

# --- è®­ç»ƒå¾ªç¯ ---
print(f"å¼€å§‹è®­ç»ƒ LSTM æ¨¡å‹ (ä½¿ç”¨è®¾å¤‡: {DEVICE})...")

for epoch in range(EPOCHS):
    start_time = time.time()
    total_loss = 0
    model.train()

    for x, y in loader:
        x, y = x.to(DEVICE), y.to(DEVICE)

        optimizer.zero_grad()
        outputs = model(x)
        loss = criterion(outputs, y)
        loss.backward()
        optimizer.step()

        total_loss += loss.item()

    avg_loss = total_loss / len(loader)
    print(f"Epoch {epoch+1} | Loss: {avg_loss:.4f} | Time: {time.time()-start_time:.1f}s")

# --- ä¿å­˜ ---
torch.save(model.state_dict(), "lstm_traffic_model.pth")
print("æ¨¡å‹å·²ä¿å­˜ï¼")
```

---

## äº”ã€æ€»ç»“ï¼šCNN vs LSTM æ€ä¹ˆé€‰ï¼Ÿ

å­¦å®Œäº†ä¸¤ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªæœ€ç»ˆå¯¹æ¯”ï¼š

| ç»´åº¦           | CNN (ä¸Šä¸€ç¯‡)                     | LSTM (æœ¬ç¯‡)                        |
| :------------- | :------------------------------- | :--------------------------------- |
| **æ ¸å¿ƒé€»è¾‘**   | **ç‰¹å¾æ£€æµ‹** (Feature Detection) | **åºåˆ—å»ºæ¨¡** (Sequential Modeling) |
| **çœ‹æ•°æ®æ–¹å¼** | æ‹¿ç€æ”¾å¤§é•œåˆ°å¤„æ‰«å…³é”®è¯           | ä»å¤´è¯»åˆ°å°¾ï¼Œç†è§£ä¸Šä¸‹æ–‡             |
| **é€Ÿåº¦**       | å¿« (å¹¶è¡Œè®¡ç®—)                    | æ…¢ (ä¸²è¡Œè®¡ç®—)                      |
| **æ“…é•¿é¢†åŸŸ**   | é’“é±¼ç½‘ç«™ã€æ˜æ˜¾çš„ SQL æ³¨å…¥        | DGA åŸŸåã€æ··æ·†ä»£ç ã€Webshell æµé‡  |
| **å‚æ•°é‡**     | è¾ƒå°‘                             | è¾ƒå¤š (4å€äºåŒå®½åº¦çš„ CNN)           |

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®ï¼š**
åœ¨å·¥ä¸šç•Œ AI å®‰å…¨è½åœ°æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šäºŒé€‰ä¸€ï¼Œè€Œæ˜¯ï¼š

1.  **å…ˆè·‘ CNN**ï¼šä½œä¸ºåŸºçº¿ï¼ˆBaselineï¼‰ï¼Œå› ä¸ºå®ƒå¿«ä¸”æ•ˆæœä¸é”™ã€‚
2.  **å†è¯• LSTM**ï¼šå¦‚æœå‘ç°æœ‰å¾ˆå¤šé€»è¾‘å¤æ‚çš„æ”»å‡»ï¼ˆå¦‚ DGAï¼‰æ¼æŠ¥ï¼Œå†å¼•å…¥ LSTMã€‚
3.  **åŒå‰‘åˆç’§ (C-LSTM)**ï¼šå‰é¢ç”¨ CNN æå–å±€éƒ¨ç‰¹å¾ï¼Œåé¢æ¥ LSTM æå–æ—¶åºç‰¹å¾ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰å­¦æœ¯ç•Œéå¸¸æµè¡Œçš„ç»“æ„ã€‚

å¸Œæœ›é€šè¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼Œä½ å·²ç»å½»åº•å©å¼€äº†æ·±åº¦å­¦ä¹ å®‰å…¨é˜²å¾¡çš„å¤§é—¨ï¼
